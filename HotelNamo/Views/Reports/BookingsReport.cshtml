@model IEnumerable<HotelNamo.Models.Booking>
@{
    ViewData["Title"] = "Booking Report";
    Layout = "_AdminLayout";

    // Calculate key metrics for dashboard
    var totalBookings = Model.Count();
    var confirmedBookings = Model.Count(b => b.IsConfirmed);
    var confirmedPercentage = totalBookings > 0 ? (confirmedBookings * 100) / totalBookings : 0;
    var totalRevenue = Model.Sum(b => b.TotalPrice);
    var avgBookingValue = totalBookings > 0 ? totalRevenue / totalBookings : 0;

    // Group by status for chart
    var statusGroups = Model.GroupBy(b => b.IsConfirmed ?
                           (b.ActualCheckOutTime != null ? "Completed" :
                             (b.ActualCheckInTime != null ? "Checked In" : "Confirmed")) :
                           "Pending")
                        .Select(g => new { Status = g.Key, Count = g.Count() })
                        .OrderBy(g => g.Status);

    // Group by month for trend
    var monthlyData = Model.GroupBy(b => new { b.BookingDate.Year, b.BookingDate.Month })
                          .Select(g => new
                          {
                              Period = $"{g.Key.Year}-{g.Key.Month:D2}",
                              Count = g.Count(),
                              Revenue = g.Sum(b => b.TotalPrice)
                          })
                          .OrderBy(g => g.Period)
                          .Take(6); // Show last 6 months
}

<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="fa-solid fa-chart-column me-2"></i>Booking Report</h4>
            <div>
                <a href="#" class="btn btn-outline-primary btn-sm me-2" id="reportPrintBtn">
                    <i class="fa-solid fa-print me-1"></i> Print
                </a>
                <a href="#" class="btn btn-outline-success btn-sm" id="reportExportBtn">
                    <i class="fa-solid fa-file-excel me-1"></i> Export
                </a>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Date Range Filter -->
        <form method="get" class="mb-4 p-3 border rounded bg-light">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">From Date</label>
                    <input type="date" name="fromDate" class="form-control" value="@ViewBag.FromDate" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">To Date</label>
                    <input type="date" name="toDate" class="form-control" value="@ViewBag.ToDate" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-select">
                        <option value="">All Statuses</option>
                        @if (ViewBag.Status == "pending")
                        {
                            <option value="pending" selected>Pending</option>
                        }
                        else
                        {
                            <option value="pending">Pending</option>
                        }

                        @if (ViewBag.Status == "confirmed")
                        {
                            <option value="confirmed" selected>Confirmed</option>
                        }
                        else
                        {
                            <option value="confirmed">Confirmed</option>
                        }

                        @if (ViewBag.Status == "checkedIn")
                        {
                            <option value="checkedIn" selected>Checked In</option>
                        }
                        else
                        {
                            <option value="checkedIn">Checked In</option>
                        }

                        @if (ViewBag.Status == "completed")
                        {
                            <option value="completed" selected>Completed</option>
                        }
                        else
                        {
                            <option value="completed">Completed</option>
                        }
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fa-solid fa-filter me-1"></i> Apply Filters
                    </button>
                </div>
            </div>
        </form>

        <!-- Key Metrics -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3 mb-md-0">
                <div class="card border-0 bg-primary text-white h-100">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-white-50 mb-0">Total Bookings</h6>
                                <h2 class="fw-bold mb-0">@totalBookings</h2>
                            </div>
                            <div class="stats-icon">
                                <i class="fa-solid fa-calendar-check fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3 mb-md-0">
                <div class="card border-0 bg-success text-white h-100">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-white-50 mb-0">Confirmation Rate</h6>
                                <h2 class="fw-bold mb-0">@confirmedPercentage%</h2>
                            </div>
                            <div class="stats-icon">
                                <i class="fa-solid fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3 mb-md-0">
                <div class="card border-0 bg-info text-white h-100">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-white-50 mb-0">Total Revenue</h6>
                                <h2 class="fw-bold mb-0">$@totalRevenue.ToString("N0")</h2>
                            </div>
                            <div class="stats-icon">
                                <i class="fa-solid fa-dollar-sign fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3 mb-md-0">
                <div class="card border-0 bg-warning text-white h-100">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-white-50 mb-0">Avg. Booking Value</h6>
                                <h2 class="fw-bold mb-0">$@avgBookingValue.ToString("N0")</h2>
                            </div>
                            <div class="stats-icon">
                                <i class="fa-solid fa-chart-line fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6 mb-4 mb-md-0">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Booking Status Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div style="height: 250px;">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Monthly Booking Trend</h5>
                    </div>
                    <div class="card-body">
                        <div style="height: 250px;">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Booking Data Table -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">Booking Details</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="bookingTable">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Guest</th>
                                <th>Room</th>
                                <th>Check-In</th>
                                <th>Check-Out</th>
                                <th>Status</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var booking in Model)
                            {
                                <tr>
                                    <td>@booking.Id</td>
                                    <td>
                                        @if (booking.IsGuestBooking)
                                        {
                                            @booking.GuestName
                                        }
                                        else
                                        {
                                            @(booking.User?.FirstName + " " + booking.User?.LastName)
                                        }
                                    </td>
                                    <td>@(booking.Room?.RoomNumber ?? "N/A")</td>
                                    <td>@booking.CheckInDate.ToString("MMM dd, yyyy")</td>
                                    <td>@booking.CheckOutDate.ToString("MMM dd, yyyy")</td>
                                    <td>
                                        @if (!booking.IsConfirmed)
                                        {
                                            <span class="badge bg-warning">Pending</span>
                                        }
                                        else if (booking.ActualCheckInTime != null && booking.ActualCheckOutTime == null)
                                        {
                                            <span class="badge bg-primary">Checked In</span>
                                        }
                                        else if (booking.ActualCheckOutTime != null)
                                        {
                                            <span class="badge bg-success">Completed</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-info">Confirmed</span>
                                        }
                                    </td>
                                    <td>$@booking.TotalPrice.ToString("F2")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Status distribution chart
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        const statusChart = new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: [@Html.Raw(string.Join(",", statusGroups.Select(g => $"'{g.Status}'")))],
                datasets: [{
                    data: [@string.Join(",", statusGroups.Select(g => g.Count))],
                    backgroundColor: [
                        'rgba(255, 193, 7, 0.8)', // Pending (warning)
                        'rgba(23, 162, 184, 0.8)', // Confirmed (info)
                        'rgba(0, 123, 255, 0.8)', // Checked In (primary)
                        'rgba(40, 167, 69, 0.8)'  // Completed (success)
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Monthly trend chart
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        const trendChart = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: [@Html.Raw(string.Join(",", monthlyData.Select(g => $"'{g.Period}'")))],
                datasets: [{
                    label: 'Bookings',
                    data: [@string.Join(",", monthlyData.Select(g => g.Count))],
                    borderColor: 'rgba(0, 123, 255, 1)',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });

        // Print functionality
        document.getElementById('reportPrintBtn').addEventListener('click', function(e) {
            e.preventDefault();
            window.print();
        });

        // Export functionality (simplified)
        document.getElementById('reportExportBtn').addEventListener('click', function(e) {
            e.preventDefault();
            alert('Export functionality would be implemented here.');
            // In a real implementation, you would use a library like ExcelJS or SheetJS
            // to generate an Excel file from the table data
        });
    </script>
    <style>
        .stats-icon {
            opacity: 0.8;
        }

        @@ media print {
            .admin-navbar, .sidebar, .card-header, form

        {
            display: none !important;
        }

        .card {
            border: none !important;
            box-shadow: none !important;
        }

        .content-wrapper {
            margin-left: 0 !important;
            padding: 0 !important;
        }

        }
    </style>
}